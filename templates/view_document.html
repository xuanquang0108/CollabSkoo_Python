{% extends 'layouts/base.html' %}
{% block title %}CollabSkoo - {{ document.title }}{% endblock %}
{% block content %}
<!-- CSS thuần -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<!-- pdf.js CDN -->
<!-- 1. Đặt lên đầu <head> hoặc ngay trước </body> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="{{ url_for('static', filename='js/livesearch.js') }}"></script>

<section class="document-hero">
  <div class="document-hero-overlay"></div>
  <div class="document-hero-content">
    <h1>{{ document.title }}</h1>
  </div>
</section>

<section class="container">
  <!-- Thông tin tài liệu -->
  <div>
    <div class="document-grid">
      <!-- Cột thông tin -->
      <div class="document-info-view-document">
        <p><strong>Ngành:</strong>
          {% set category = (categories | selectattr('id', 'equalto', document.category | string) | first) %}
          {{ category.name if category else 'Không xác định' }}
        </p>
        <p><strong>Phân loại:</strong>
          {% set doc_type = (document_types | selectattr('id', 'equalto', document.document_type | string) | first) %}
          {{ doc_type.name if doc_type else 'Không xác định' }}
        </p>
        <p><strong>Giảng viên:</strong> {{ document.lecturer or 'Không có' }}</p>
        <p><strong>Số trang:</strong> {{ page_count }}</p>
        <p><strong>Năm xuất bản:</strong> {{ document.publish_year or 'Không xác định' }}</p>
        <!-- Nút tải xuống -->
        <a href="{{ url_for('download_document', filename=document.file_path.split('/')[-1]) }}"
           class="download-btn-view-document">Tải xuống</a>
      </div>
    </div>
  </div>

  <!-- Khung preview PDF -->
  <div class="preview-card">
    <h2>Xem trước tài liệu</h2>
    {% if document.file_path.endswith('.pdf') %}
      <div class="preview-controls">
        <button id="prev-page" class="preview-btn">Trang trước</button>
        <span id="page-num"></span>
        <button id="next-page" class="preview-btn">Trang sau</button>
      </div>
      <div id="pdf-error"></div>
      <canvas id="pdf-canvas"></canvas>
    {% else %}
      <p>Chỉ hỗ trợ xem trước file PDF.</p>
    {% endif %}
  </div>
</section>

<!-- JavaScript cho pdf.js -->
<script>
  // Đồng bộ worker với pdf.js 2.16.105
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

  // Lấy đúng URL đến file PDF trong static/uploads
  const pdfUrl = "{{ url_for('static', filename=document.file_path.split('static/')[1]) }}";
  let pdfDoc = null,
      pageNum = 1,
      pageIsRendering = false,
      pageNumPending = null,
      scale = 1.5;

  const canvas       = document.getElementById('pdf-canvas');
  const ctx          = canvas.getContext('2d');
  const prevButton   = document.getElementById('prev-page');
  const nextButton   = document.getElementById('next-page');
  const pageNumDisplay = document.getElementById('page-num');
  const errorDisplay = document.getElementById('pdf-error');

  function renderPage(num) {
    pageIsRendering = true;
    pdfDoc.getPage(num).then(page => {
      const viewport = page.getViewport({ scale });
      canvas.height = viewport.height;
      canvas.width  = viewport.width;

      page.render({ canvasContext: ctx, viewport })
          .promise.then(() => {
            pageIsRendering = false;
            if (pageNumPending !== null) {
              renderPage(pageNumPending);
              pageNumPending = null;
            }
          });

      pageNumDisplay.textContent = `Trang ${num} / ${pdfDoc.numPages}`;
    }).catch(err => {
      errorDisplay.textContent = 'Lỗi khi hiển thị trang: ' + err.message;
      errorDisplay.style.display = 'block';
    });
  }

  function queueRenderPage(num) {
    if (pageIsRendering) {
      pageNumPending = num;
    } else {
      renderPage(num);
    }
  }

  // Chỉ load PDF nếu đúng .pdf
  if (pdfUrl.toLowerCase().endsWith('.pdf')) {
    pdfjsLib.getDocument(pdfUrl).promise
      .then(pdf => {
        pdfDoc = pdf;
        renderPage(pageNum);
      })
      .catch(err => {
        errorDisplay.textContent = 'Không thể tải PDF: ' + err.message;
        errorDisplay.style.display = 'block';
      });

    prevButton.addEventListener('click', () => {
      if (pageNum <= 1) return;
      pageNum--;
      queueRenderPage(pageNum);
    });

    nextButton.addEventListener('click', () => {
      if (pageNum >= pdfDoc.numPages) return;
      pageNum++;
      queueRenderPage(pageNum);
    });
  } else {
    errorDisplay.textContent = 'Chỉ hỗ trợ xem file PDF.';
    errorDisplay.style.display = 'block';
  }
</script>

{% endblock %}